version: '3.8'

services:
  # ----------------------------------------------------------------
  # 1. BAZA DE DATE
  # ----------------------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: fbi_db
    restart: always
    env_file: .env
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "${DB_PORT_EXTERNAL}:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------
  # 2. KEYCLOAK
  # ----------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: fbi_keycloak
    restart: always
    command: start-dev
    env_file: .env
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://db:5432/${KEYCLOAK_DB_NAME}
      KC_DB_USERNAME: ${DB_USER}
      KC_DB_PASSWORD: ${DB_PASSWORD}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      
      KC_HOSTNAME: https://silviu-proiect.space
      # Spunem ca suntem in spatele unui proxy (Nginx)
      KC_PROXY_HEADERS: xforwarded
      # Activam modul HTTP intern (ca sa vorbeasca Nginx cu el pe port 8080)
      KC_HTTP_ENABLED: "true"
      
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME_STRICT: "false"
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app_network

  # ----------------------------------------------------------------
  # 3. RABBITMQ
  # ----------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: fbi_rabbitmq
    restart: always
    env_file: .env
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - app_network

  # ----------------------------------------------------------------
  # 4. MINIO
  # ----------------------------------------------------------------
  minio:
    image: minio/minio
    container_name: fbi_minio
    restart: always
    command: server /data --console-address ":9001"
    env_file: .env
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - app_network

  # ----------------------------------------------------------------
  # 5. BACKEND (Main API)
  # ----------------------------------------------------------------
  backend:
    build: 
      context: ./fbi-backend
      # Nu e nevoie sa specifici 'dockerfile: Dockerfile' daca are numele standard
    container_name: fbi_backend
    restart: unless-stopped
    env_file: .env
    environment:
      ASPNETCORE_URLS: "http://+:7002"
      ConnectionStrings__DefaultConnection: "Host=db;Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD}"
      Keycloak__Authority: http://keycloak:8080/realms/${KEYCLOAK_REALM}
      Keycloak__Url: http://keycloak:8080
      Keycloak__TokenUrl: http://keycloak:8080/realms/${KEYCLOAK_REALM}/protocol/openid-connect/token
      Keycloak__ClientId: ${KEYCLOAK_CLIENT_ID}
      Keycloak__ClientSecret: ${KEYCLOAK_CLIENT_SECRET}
      Keycloak__Admin: ${KEYCLOAK_ADMIN}
      Keycloak__AdminPassword: ${KEYCLOAK_ADMIN_PASSWORD}
      Keycloak__Realm: ${KEYCLOAK_REALM}
      Stripe__PublishableKey: ${STRIPE_PUB_KEY}
      Stripe__SecretKey: ${STRIPE_SECRET_KEY}
      Stripe__WebhookSecret: ${STRIPE_WEBHOOK}
      EmailSettings__SmtpServer: ${SMTP_SERVER}
      EmailSettings__Port: ${SMTP_PORT}
      EmailSettings__Username: ${SMTP_USER}
      EmailSettings__Password: ${SMTP_PASS}
      Supabase__Url: ${SUPABASE_URL}
      Supabase__Key: ${SUPABASE_KEY}
      FaceRecognition__Url: http://python-ai:8006
      FaceRecognition__ApiKey: ${FACE_RECOG_API_KEY}
      RabbitMq__Host: rabbitmq
      RabbitMq__Username: ${RABBITMQ_USER}
      RabbitMq__Password: ${RABBITMQ_PASSWORD}
      RabbitMq__Queue: ${RABBITMQ_QUEUE_ANALYSIS}
      RabbitMq__ReceiveQueue: ${RABBITMQ_QUEUE_FINISHED}
    ports:
      - "7002:7002"
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_started
      keycloak:
        condition: service_started
      minio:
        condition: service_started
    networks:
      - app_network

  # ----------------------------------------------------------------
  # 6. FRONTEND (Corectat args)
  # ----------------------------------------------------------------
  frontend:
    build:
      context: ./fbi-frontend
      # ATENTIE: args trebuie sa fie SUB 'build', nu in afara lui!
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_WEBSOCKETS_URL: ${NEXT_PUBLIC_WEBSOCKETS_URL}
        NEXT_PUBLIC_FILE_API: ${NEXT_PUBLIC_FILE_API}
        NEXT_PUBLIC_FILE_API_KEY: ${NEXT_PUBLIC_FILE_API_KEY}
    container_name: fbi_frontend
    restart: unless-stopped
    env_file: .env
    # Environment e doar pentru runtime, args e pentru build time (ambele necesare la NextJS uneori)
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_WEBSOCKETS_URL: ${NEXT_PUBLIC_WEBSOCKETS_URL}
      NEXT_PUBLIC_FILE_API: ${NEXT_PUBLIC_FILE_API}
      NEXT_PUBLIC_FILE_API_KEY: ${NEXT_PUBLIC_FILE_API_KEY}
    ports:
      - "3000:3000"
    networks:
      - app_network

  # ----------------------------------------------------------------
  # 7. NGINX
  # ----------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: fbi_gateway
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      # AICI E SCHIMBAREA: Montam folderele Let's Encrypt
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - backend
      - frontend
      - keycloak
    networks:
      - app_network
  
  certbot:
    image: certbot/certbot
    container_name: fbi_certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      
  # ----------------------------------------------------------------
  # 8. PYTHON AI (Corectat Network)
  # ----------------------------------------------------------------
  python-ai:
    build:
      context: ./face-recog-microservice/
    container_name: fbi_python_ai
    restart: unless-stopped
    env_file: .env
    environment:
      AI_SERVICE_PORT: 8006
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASSWORD}
      RABBIT_HOST: rabbitmq
      RABBIT_USER: ${RABBITMQ_USER}
      RABBIT_PASS: ${RABBITMQ_PASSWORD}
      RABBIT_QUEUE: ${RABBITMQ_QUEUE_ANALYSIS}
      RABBIT_QUEUE_PUBLISH: ${RABBITMQ_QUEUE_FINISHED}
      API_KEY: ${FACE_RECOG_API_KEY}
      RUN_SYNC_AT_STARTUP: "False"
    ports:
      - "8006:8006"
    depends_on:
      - db
      - rabbitmq
    networks:
      - app_network

  # ----------------------------------------------------------------
  # 9. FILE API (Corectat Network)
  # ----------------------------------------------------------------
  file-api:
    build:
      context: ./fbi-media-service
    container_name: fbi_file_api
    restart: unless-stopped
    env_file: .env
    environment:
      ASPNETCORE_URLS: "http://+:7005"
      Minio__Url: http://minio:9000
      Minio__SecretKey: ${MINIO_ROOT_PASSWORD}
      Minio__AccessKey: ${MINIO_ROOT_USER}
      Minio__Bucketname: ${MINIO_BUCKET}
      Minio__PublicUrl: ${MINIO_PUBLIC_URL}
      AppPort: 7005
      ApiKey: ${API_KEY_SHARED}
    ports:
      - "7005:7005"
    depends_on:
      - minio
    networks:
      - app_network

# ----------------------------------------------------------------
# RETELE UNIFICATE
# ----------------------------------------------------------------
networks:
  app_network:
    driver: bridge

volumes:
  db_data:
  minio_data: