# 1. UPSTREAMS (Definim unde trimitem traficul)
upstream frontend_upstream {
    server frontend:3000;
}

upstream backend_upstream {
    server backend:7002;
}

upstream file_api_upstream {
    server file-api:7005;
}

upstream keycloak_upstream {
    server keycloak:8080;
}
upstream minio_upstream {
    server minio:9000;
}

upstream minio_console_upstream {
    server minio:9001;
}

# 2. HTTP SERVER (Port 80)
# Acesta se ocupa de validarea Certbot si de redirectare catre HTTPS
server {
    listen 80;
    server_name silviu-proiect.space www.silviu-proiect.space;

    # Aici vine Certbot sa verifice ca tu detii domeniul
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Orice alta cerere e trimisa fortat pe HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# 3. HTTPS SERVER (Port 443) - SSL
# ==============================================================================
# IMPORTANT: Daca rulezi pentru PRIMA DATA si nu ai certificatele, 
# COMENTEAZA TOT BLOCUL DE MAI JOS (pune # la fiecare linie sau sterge-l temporar)
# Dupa ce generezi certificatele cu Certbot, il decomentezi la loc.
# ==============================================================================
server {
    listen 443 ssl;
    # IMPORTANT: Doar domeniul simplu
    server_name silviu-proiect.space;

    # Caile catre certificate
    ssl_certificate /etc/letsencrypt/live/silviu-proiect.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/silviu-proiect.space/privkey.pem;

    # ... restul setarilor SSL si Proxy raman la fel ...
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # ... location / ... etc
	
	proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # --- RUTELE TALE ---

    # 1. Admin Keycloak
    location /admin/ { proxy_pass http://keycloak_upstream; }
    location /realms/ { proxy_pass http://keycloak_upstream; }
    location /resources/ { proxy_pass http://keycloak_upstream; }
    location /js/ { proxy_pass http://keycloak_upstream; }

    # 2. Backend API
    location /api/ {
        proxy_pass http://backend_upstream;
    }

	# 3. WebSockets (SignalR)
	location /hubs/ {
        # Trimitem request-ul la backend
        proxy_pass http://backend:7002/hubs/;

        # --- SETARI CRITICE WEBSOCKET ---
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Dezactivam buffering-ul (CRITIC pentru SignalR)
        proxy_buffering off;
        
        # Setari standard
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Previne inchiderea conexiunii daca e liniste
        proxy_read_timeout 100s;
        proxy_send_timeout 100s;
        
        proxy_cache_bypass $http_upgrade;
    }

    # 4. File API (Upload)
    location /upload {
        # OBSERVATIE: Am scos "/upload" din proxy_pass. 
        # Cand nu pui path in proxy_pass, Nginx trimite URL-ul original complet.
        proxy_pass http://file_api_upstream;
        
        client_max_body_size 100M;

        # Headerele standard (le poti copia de sus sau lasa daca sunt globale, 
        # dar e bine sa fie si aici pentru siguranta)
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
	
	location /files/ {
        # OBS: Slash-ul de la finalul proxy_pass este MAGIC.
        # El spune Nginx-ului sa STEARGA "/files/" din URL inainte sa trimita la MinIO.
        proxy_pass http://minio_upstream/;
        
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # MinIO poate returna chunk-uri, deci debifam buffering daca e cazul (optional)
        proxy_buffering off;
    }
	
	location /minio/ {
        # Slash-ul de la final e important, sterge "/minio" din cerere
        proxy_pass http://minio_console_upstream/;
        
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Setari critice pentru WebSockets (MinIO Console le foloseste intens)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Origin ""; # Uneori ajuta la CORS in UI
        
        # Debifam buffering ca sa se miste rapid interfata
        proxy_buffering off;
        chunked_transfer_encoding off;
    }

    # 5. Frontend (NextJS)
    location / {
        proxy_pass http://frontend_upstream;
    }
}